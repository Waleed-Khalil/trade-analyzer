# Trade Analyzer Configuration
# Paste an option play (e.g. from Discord); get Go/No-Go, stop, targets, and levels.
# ODE = same-day expiration (0DTE) — uses tighter risk parameters.

# Account Settings
account:
  total_capital: 100000        # Total portfolio value ($)
  max_risk_per_trade: 0.02     # 2% max risk per trade
  max_risk_per_day: 0.06       # 6% max daily loss limit
  max_open_positions: 5        # Max concurrent trades

# Position Sizing
sizing:
  default_contracts: 1         # Fallback if calculation fails
  min_premium_to_consider: 0.50  # Ignore cheap premiums
  use_volatility_adjustment: true  # Reduce size in high IV

# Stop Loss Rules (standard)
stops:
  default_pct: 0.50           # 50% of premium as initial stop
  max_loss_per_contract: 500  # Hard cap on $ loss per contract
  profit_protection: true     # Move to breakeven at 2R
  profit_protection_r: 2.0    # At 2x risk, trail to breakeven
  # ATR-based vol-adjusted levels (Yahoo daily OHLC); augments rule-based SL/targets
  atr:
    period: 14                # Wilder ATR lookback (days)
    days_back: 60             # History to fetch for ATR
    sl_multiplier: 1.5        # Stop: entry - (sl_mult * ATR * delta)
    t1_multiplier: 2.0        # T1: entry + (t1_mult * ATR * delta)
    t2_multiplier: 4.0        # Runner/T2 multiplier
    use_delta_adjust: true    # Scale premium impact by option delta
    fallback_delta: 0.5       # When Greeks missing (OTM-ish call default)
    min_atr_threshold: 1.0    # If ATR < this, flag "low vol – static levels preferred"
    # When vol-adjusted SL <= 0, floor to this fraction of entry premium (e.g. 0.2 = 20%)
    atr_sl_floor_fraction: 0.2
    # When |delta| < this, optional fixed risk for SL floor (e.g. 0.5 = 50% of premium)
    low_delta_threshold: 0.3

# ODE / 0DTE (same-day expiration) — tighter rules
ode:
  enabled: true               # Apply ODE rules when same-day expiration detected
  stop_pct: 0.35              # Tighter stop: 35% of premium (theta/gamma risk)
  max_loss_per_contract: 300  # Lower cap per contract
  profit_target_r: 1.5        # First target at 1.5R (take profits faster)
  runner_activation_r: 2.0    # Consider taking runner off earlier
  runner_remaining_pct: 0.50
  max_runner_target_r: 3.0    # Hard target for runner (don't get greedy)
  min_premium: 0.30           # Lower min premium for 0DTE (lotto-style)

# Target & Runner Rules (standard)
targets:
  profit_target_r: 2.0         # First target at 2x risk
  runner_activation_r: 3.0     # Sell half at 3x risk
  runner_remaining_pct: 0.50   # Keep 50% for runner
  max_runner_target_r: 5.0     # Hard target for runner
  trailing_stop_runner: 0.25   # Trail runner by 25% of peak

# AI Analysis (Anthropic-compatible API) — Go/No-Go, reasoning, stop, targets, support/resistance
# For MiniMax: set ANTHROPIC_BASE_URL=https://api.minimax.io/anthropic and use model MiniMax-M2.1
# For Anthropic: use model claude-sonnet-4-5 (no base URL needed)
analysis:
  enabled: true
  provider: anthropic
  model: MiniMax-M2.1  # or claude-sonnet-4-5
  llm_enabled: true  # Enable LLM-enhanced natural language analysis
  # Set ANTHROPIC_API_KEY environment variable
  # Set ANTHROPIC_BASE_URL for alternative providers (e.g., MiniMax)
  red_flag_checks:
    iv_rank_above_70: "High IV Rank - theta decay risk"
    days_to_expiration_below_3: "Expiration < 3 days - gamma risk"
    strike_otm_above_10: "Strike > 10% OTM - low delta"
    premium_too_low: "Premium too low for effective hedging"
    size_exceeds_max: "Position size exceeds calculated maximum"
  # Greeks & probabilities: downgrade to HOLD/AVOID when breached
  greeks:
    pop_min: 0.50          # Probability of Profit below this => flag
    theta_high_decay: -0.05  # Theta more negative than this => fast time decay risk
    vega_high: 0.20        # Vega above => high IV sensitivity
    option_volume_min: 500   # Option volume below => liquidity red flag
    open_interest_min: 1000 # OI below => liquidity red flag
    quote_spread_pct_max: 15  # Bid/ask spread above this % of mid => wide-spread red flag
  # Stress test: instant underlying move scenarios (P/L via Black-Scholes reprice)
  stress:
    scenarios: [-0.02, -0.01, 0.01, 0.02]  # % as decimals: -2%, -1%, +1%, +2%
    # Current short-term risk-free rate (3-mo T-bill); update periodically from Treasury.gov or FRED
    risk_free_rate: 0.0367
    # Flag if -1% move causes loss >= this % of risk (vulnerable to small downside). Tunable.
    downside_1pct_loss_threshold_pct: 50
  # IV Rank & vol context (historical IV: Massive recompute or external; realized vol from Yahoo)
  iv_rank:
    lookback_days: 365        # 52w for rank when historical IV available
    rank_high_threshold: 80   # Rank > this => overpriced, caution on longs
    rank_low_threshold: 30    # Rank < this => low IV, favorable for buys
    realized_vol_window: 30   # Days for realized vol (Yahoo daily closes)
    # Recompute historical IV from Massive option aggs + Yahoo spot (no pre-computed IV API)
    use_historical_recompute: true
    max_historical_iv_days: 126  # Cap lookback to limit Massive API calls and compute (~6 months)
    min_historical_samples: 30   # Require at least this many valid IVs for rank; else N/A
    solver_sigma_low: 0.001      # IV solver (brentq) lower bound; tune if extreme IVs fail
    solver_sigma_high: 5.0       # IV solver upper bound (500% annualized)
    # When historical IV is N/A, use 52w realized-vol rank as IV proxy (yfinance only)
    use_hv_rank_fallback: true
  # Support/Resistance analysis (price action vs psychological levels)
  support_resistance:
    enabled: true
    method: "price_action"  # "price_action", "psychological", "hybrid"
    lookback_days: 60
    min_touches: 2
    zone_clustering_pct: 0.5
    atr_significance_multiplier: 0.3
    max_levels: 5

  # Volume analysis (VWAP, volume profile, anomalies)
  volume:
    enabled: true
    vwap_enabled: true
    volume_profile_enabled: true
    volume_spike_threshold: 2.0
    price_bins: 50
    value_area_pct: 0.70
    vwap_deviation_warning_pct: 2.0

  # Candlestick pattern recognition
  patterns:
    enabled: true
    lookback_bars: 10
    detect_patterns: ["engulfing", "pinbar", "doji", "morning_star", "evening_star", "hammer", "shooting_star"]
    require_volume_confirmation: true
    bonus_at_sr: 12  # Bonus to setup_score when pattern at S/R (increased from 10)

  # Trend analysis (ADX, structure, multi-timeframe)
  trend:
    enabled: true
    adx_period: 14
    adx_trending_threshold: 25
    adx_weak_threshold: 20
    multi_timeframe: [daily, 4h, 1h]
    alignment_bonus: 20  # Bonus to setup_score for multi-TF alignment (increased from 15)
    counter_trend_severity: "high"  # Severity for counter-trend trades
    trendline_min_touches: 2

  # Fibonacci retracements and extensions
  fibonacci:
    enabled: true
    retracement_levels: [0.236, 0.382, 0.5, 0.618, 0.786]
    extension_levels: [1.272, 1.414, 1.618, 2.618]
    lookback_days: 60  # Find swing high/low from this period

  # Multi-timeframe technical confluence (RSI, MACD, SMA) for setup quality
  technical:
    enabled: true
    timeframes: [daily, 1h]
    rsi_period: 14
    rsi_overbought: 70
    rsi_oversold: 30
    rsi_min_bullish: 50         # For calls: RSI above = bullish confluence
    rsi_max_bearish: 50         # For puts: RSI below = bearish confluence
    sma_periods: [20, 50]
    macd_fast: 12
    macd_slow: 26
    macd_signal: 9
    confluence_score_bonus: 15   # Add to setup_score when bullish/bearish confluence

# Dynamic Exit Strategies (Phase 5)
trailing_stops:
  enabled: true
  atr_trailing:
    initial_multiplier: 1.5  # ATR multiplier for initial profit phase
    mid_multiplier: 2.0      # ATR multiplier at 2R+ profit
    high_multiplier: 2.5     # ATR multiplier at 4R+ profit
  technical_trailing:
    enabled: true
    min_distance_from_entry: 0.5  # Minimum % from entry for technical stop
  breakeven:
    r_trigger: 2.0           # Move to breakeven at this R multiple
    technical_trigger_zones: 2  # Or after clearing 2 resistance zones
    confluence_score_threshold: 70  # Or when score hits this

# Partial Exit Management (Phase 5)
partial_exits:
  enabled: true
  scaling_method: 'technical_weighted'  # 'technical_weighted', 'r_based', 'equal'
  r_based:
    t1_contracts_pct: 0.40   # Take 40% at T1 (2R)
    t2_contracts_pct: 0.30   # Take 30% at T2 (3R)
    runner_contracts_pct: 0.30  # Let 30% run to T3 (5R+)

# Exit Pattern Detection (Phase 5)
exit_patterns:
  enabled: true
  min_profit_pct: 0.20     # Only trigger exit patterns when profit >20%
  require_volume_confirmation: true
  volume_spike_threshold: 1.5  # Volume must be >1.5x average

# Smart Position Sizing (Phase 6)
sizing:
  method: 'composite'  # 'composite', 'kelly', 'fixed'
  kelly:
    enabled: true
    fractional_kelly: 0.25   # Use 1/4 Kelly for safety
    min_trades_for_kelly: 30  # Need this many trades for Kelly calculation
  volatility:
    enabled: true
    adjustment_range: [0.5, 1.5]  # Size down/up based on IV
    high_iv_threshold: 70    # IV rank >70 = reduce size
    low_iv_threshold: 30     # IV rank <30 = increase size
  setup_quality:
    enabled: true
    score_brackets:
      exceptional: [90, 100, 1.5]  # 90-100 score = 1.5x size
      high: [80, 89, 1.25]         # 80-89 score = 1.25x size
      good: [70, 79, 1.0]          # 70-79 score = 1.0x size
      medium: [60, 69, 0.75]       # 60-69 score = 0.75x size
  equity_curve:
    enabled: true
    lookback_trades: 10      # Look at last N trades
    adjustment_range: [0.5, 1.3]  # Scale down/up based on performance
    consecutive_loss_threshold: 3  # Reduce after 3 losses

# Risk Management Enhancements
risk_management:
  correlation:
    enabled: true
    max_correlated_risk_pct: 0.06  # Max 6% risk in correlated positions
    groups:
      TECH: ['AAPL', 'MSFT', 'GOOGL', 'AMZN', 'META', 'NVDA', 'TSLA']
      SPY_RELATED: ['SPY', 'SPX', 'QQQ', 'DIA', 'IWM']
      FINANCE: ['JPM', 'BAC', 'GS', 'MS', 'C']
  drawdown:
    enabled: true
    tiers:
      normal: [0, 5, 1.0]      # 0-5% DD = normal sizing
      caution: [5, 10, 0.75]   # 5-10% DD = 75% size
      warning: [10, 15, 0.5]   # 10-15% DD = 50% size
      critical: [15, 100, 0.25]  # 15%+ DD = 25% size
  limits:
    max_position_pct: 0.25    # Max 25% of account in one position
    max_contracts_per_trade: 10  # Hard cap on contracts
    max_risk_per_trade: 0.05  # Max 5% risk per trade

# Performance & Caching
caching:
  enabled: true
  ttl:
    yfinance_data: 3600      # Cache for 1 hour
    technical_calcs: 1800    # Cache for 30 min
    patterns: 900            # Cache for 15 min
    iv_history: 86400        # Cache for 24 hours
  max_size_mb: 100           # Max cache size
  cleanup_interval: 3600     # Clean expired entries every hour

# Backtest: historical simulation to validate rules (yfinance only; BS for option pricing)
backtest:
  tickers: [QQQ, SPY]           # Underlyings to run
  lookback_years: 2             # Years of daily data
  min_trades: 30                # Require at least this many trades before reporting stats
  # Entry filters (setup must pass all)
  otm_pct_max: 0.02             # Call strike at most 2% OTM (0.01 = 1%)
  pop_min: 0.40                 # PoP >= 40% (BS with IV = 30d realized vol); 0.50 = fewer setups
  rv_rank_max: 80               # Realized-vol percentile (proxy for IV rank) <= 80%; 60 = stricter
  atr_rr_min: 1.5               # R/R >= 1.5:1 (target/stop in premium space); 2.0 = stricter
  # Looser baseline (20-50 trades): pop_min: 0.35, rv_rank_max: 90, atr_rr_min: 1.2
  dte_approx: 21                # Assume ~3-week options (days to expiry at entry)
  # Exit rules (aligned with stops/targets)
  target_r: 2.0                 # Take profit at 2R
  stop_pct: 0.50                # Stop at 50% of premium
  max_holding_days: 30          # Exit at expiry if not hit
  risk_free_rate: 0.0367        # Same as stress/IV solver

# Trading journal: log PLAY signals, update with exit, run summary
journal:
  enabled: true
  log_path: logs/journal.csv    # CSV; create logs/ if missing
  min_score_to_log: 75          # Only log when setup_score >= this (0 = log all PLAY)
  commission_per_contract: 1.0  # Round-trip cost per contract for P/L (2x one-way)

# Supported Alert Formats (paste from Discord or type manually)
# Premium: (\\d+\\.?\\d*|\\.\\d+) allows .20, 0.20, 3.50
alert_formats:
  - name: "demon_standard"
    pattern: "(?i)(?:BUY|SELL|SIGNAL)\\s+([A-Z]+)(?:\\s+\\d+/\\d+)?\\s*(\\d+)\\s*(CALL|PUT)\\s*@\\s*(\\d+\\.?\\d*|\\.\\d+)"
    fields: ["ticker", "strike", "type", "premium"]
    example: "BUY AAPL 01/31 215 CALL @ 3.50"

  - name: "simplified"
    pattern: "(?i)([A-Z]+)\\s+(CALL|PUT)\\s*(\\d+)\\s*@\\s*(\\d+\\.?\\d*|\\.\\d+)"
    fields: ["ticker", "type", "strike", "premium"]
    example: "AAPL CALL 215 @ 3.50"

  - name: "with_0dte"
    pattern: "(?i)(?:BUY|LONG)?\\s*([A-Z]+)\\s+(\\d+)\\s*(CALL|PUT)\\s*@\\s*(\\d+\\.?\\d*|\\.\\d+)\\s*(?:0DTE|0\\s*DTE|same\\s*day)?"
    fields: ["ticker", "strike", "type", "premium"]
    example: "NVDA 150 CALL @ 2.50 0DTE"

  - name: "ticker_strike_type_premium"
    pattern: "(?i)([A-Z]{1,5})\\s+(\\d+)\\s*(CALL|PUT)\\s*@\\s*(\\d+\\.?\\d*|\\.\\d+)"
    fields: ["ticker", "strike", "type", "premium"]
    example: "QQQ 630 CALL @ .20"

  # Optional: add " EXP YYYY-MM-DD" or " EXP MM/DD/YYYY" for DTE from date
  # Optional: add " DTE N" or " N DTE" for explicit DTE (e.g. MSFT 430 CALL @ 0.79 DTE 2)
  # Example: QQQ 628 CALL @ .63 EXP 2026-02-06
